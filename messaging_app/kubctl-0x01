#!/bin/bash
# kubctl-0x01
# Script to scale Django app in Kubernetes, verify, load test, and monitor.

set -e

DEPLOYMENT_NAME="django-messaging-deployment"   
NAMESPACE="default"            
SERVICE_NAME="django-messaging-service"  
PORT=8000

echo "üìå Scaling $DEPLOYMENT_NAME deployment to 3 replicas..."
minikube kubectl -- scale deployment $DEPLOYMENT_NAME --replicas=3 -n $NAMESPACE

echo "‚úÖ Verifying pods..."
minikube kubectl -- get pods -n $NAMESPACE -o wide

echo "‚è≥ Waiting for all pods to be ready..."
minikube kubectl -- rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE

# Expose service via minikube if not already exposed
echo "üåê Getting Django service URL..."
URL=$(minikube service $SERVICE_NAME --url -n $NAMESPACE)

echo "üîç Testing load with wrk..."
wrk -t4 -c100 -d30s $URL:$PORT

echo "üìä Monitoring resource usage..."
minikube kubectl -- top pods -n $NAMESPACE
